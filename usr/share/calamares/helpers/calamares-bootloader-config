#!/bin/bash
# Sky1 Linux bootloader configuration helper

set -e

CHROOT=$(mount | grep proc | grep calamares | awk '{print $3}' | sed -e "s#/proc##g")

# Install LUKS utilities if needed
if [ "$(mount | grep "$CHROOT " | cut -c -16)" = "/dev/mapper/luks" ]; then
    echo "UMASK=0077" > "$CHROOT/etc/initramfs-tools/conf.d/initramfs-permissions"
    chroot "$CHROOT" apt-get -y install cryptsetup-initramfs cryptsetup keyutils
fi

echo "Running Sky1 Linux bootloader configuration..."

if [ -d /sys/firmware/efi/efivars ]; then
    echo " * Installing grub-efi (UEFI mode)..."
    DEBIAN_FRONTEND=noninteractive chroot "$CHROOT" apt-get -y install grub-efi-arm64
else
    echo " * ERROR: Sky1 Linux requires UEFI boot"
    echo " * BIOS/legacy boot is not supported on ARM64"
    exit 1
fi

# Enable os-prober for dual-boot detection
sed -i "s/#GRUB_DISABLE_OS_PROBER=false/GRUB_DISABLE_OS_PROBER=false/g" "$CHROOT/etc/default/grub"

# Ensure necessary filesystems are bind-mounted for grub-probe to work
MOUNTED_DEV=false
MOUNTED_SYS=false
MOUNTED_RUN=false

if ! mountpoint -q "$CHROOT/dev"; then
    echo " * Bind mounting /dev..."
    mount --rbind /dev "$CHROOT/dev"
    mount --make-rslave "$CHROOT/dev"
    MOUNTED_DEV=true
fi

if ! mountpoint -q "$CHROOT/sys"; then
    echo " * Bind mounting /sys..."
    mount --rbind /sys "$CHROOT/sys"
    mount --make-rslave "$CHROOT/sys"
    MOUNTED_SYS=true
fi

if ! mountpoint -q "$CHROOT/run"; then
    echo " * Bind mounting /run..."
    mount --rbind /run "$CHROOT/run"
    mount --make-rslave "$CHROOT/run"
    MOUNTED_RUN=true
fi

# Update GRUB configuration
chroot "$CHROOT" /usr/sbin/update-grub

# Clean up bind mounts if we created them (reverse order)
if [ "$MOUNTED_RUN" = true ]; then
    umount -R "$CHROOT/run" 2>/dev/null || true
fi
if [ "$MOUNTED_SYS" = true ]; then
    umount -R "$CHROOT/sys" 2>/dev/null || true
fi
if [ "$MOUNTED_DEV" = true ]; then
    umount -R "$CHROOT/dev" 2>/dev/null || true
fi

echo "Bootloader configuration complete."
