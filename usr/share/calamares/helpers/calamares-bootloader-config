#!/bin/bash
# Sky1 Linux bootloader configuration helper

set -e

CHROOT=$(mount | grep proc | grep calamares | awk '{print $3}' | sed -e "s#/proc##g")

# Install LUKS utilities if needed
if [ "$(mount | grep "$CHROOT " | cut -c -16)" = "/dev/mapper/luks" ]; then
    echo "UMASK=0077" > "$CHROOT/etc/initramfs-tools/conf.d/initramfs-permissions"
    chroot "$CHROOT" apt-get -y install cryptsetup-initramfs cryptsetup keyutils
fi

echo "Running Sky1 Linux bootloader configuration..."

if [ -d /sys/firmware/efi/efivars ]; then
    echo " * Installing grub-efi (UEFI mode)..."
    DEBIAN_FRONTEND=noninteractive chroot "$CHROOT" apt-get -y install grub-efi-arm64
else
    echo " * ERROR: Sky1 Linux requires UEFI boot"
    echo " * BIOS/legacy boot is not supported on ARM64"
    exit 1
fi

# Enable os-prober for dual-boot detection
sed -i "s/#GRUB_DISABLE_OS_PROBER=false/GRUB_DISABLE_OS_PROBER=false/g" "$CHROOT/etc/default/grub"

# Ensure /dev is bind-mounted for grub-probe to work
MOUNTED_DEV=false
if ! mountpoint -q "$CHROOT/dev"; then
    echo " * Bind mounting /dev..."
    mount --bind /dev "$CHROOT/dev"
    MOUNTED_DEV=true
fi

# Update GRUB configuration
chroot "$CHROOT" /usr/sbin/update-grub

# Clean up bind mount if we created it
if [ "$MOUNTED_DEV" = true ]; then
    umount "$CHROOT/dev"
fi

echo "Bootloader configuration complete."
